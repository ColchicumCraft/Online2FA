
{% extends "layouts/base.html" %}
{% block title %}我的 TOTP 账户{% endblock %}
{% block content %}
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
  {% for it in items %}
  <div class="bg-white rounded-xl shadow p-4 flex flex-col gap-3" x-data="{code:'———', left:0}"
       x-init="(function(){
         const load = async ()=>{ try{ const r=await fetch('/api/current_code/{{ it.id }}'); const d=await r.json(); if(d.code) code=d.code; if(d.time_left!=null) left=d.time_left; }catch(e){ console.error(e); } };
         load(); setInterval(load, 1000);
       })()">
    <div class="flex items-start justify-between">
      <div>
        <div class="text-lg font-semibold">{{ it.account_name }}</div>
        <div class="text-sm text-gray-500">邮箱：{{ it.email }}</div>
      </div>
      <span class="text-xs px-2 py-1 rounded bg-violet-100 text-primary">{{ it.issuer }}</span>
    </div>
    <div>
      <div class="text-3xl font-mono tracking-widest" x-text="code"></div>
      <div class="text-sm text-gray-500">剩余 <span x-text="left"></span> 秒</div>
    </div>
    <div class="text-xs text-gray-500">添加时间：{{ it.added_at }}</div>
    <div class="mt-2 flex items-center gap-2">
      <button type="button"
              @click.stop="$dispatch('open-reveal-modal', {id: {{ it.id }}, account_name: '{{ it.account_name }}'})"
              class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded">显示密钥</button>
      <button type="button"
              @click.stop="$dispatch('open-edit-modal', {id: {{ it.id }}, name: '{{ it.account_name }}', email:'{{ it.email }}'})"
              class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded">编辑</button>
      <button type="button"
              @click.stop="if(confirm('确认删除？')) fetch('/delete/{{ it.id }}', {method:'POST'}).then(()=>location.reload())"
              class="px-3 py-2 bg-red-50 text-red-600 hover:bg-red-100 rounded">删除</button>
    </div>
    <div class="mt-2">
      {% if it.qr_png_path %}
        <img src="{{ it.qr_png_path }}" alt="QR" class="w-28 h-28 border rounded">
      {% else %}
        <a href="/qr/{{ it.id }}" target="_blank" class="text-primary hover:underline text-sm">查看二维码</a>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>
{% include "accounts/_modals.html" %}
{% endblock %}
