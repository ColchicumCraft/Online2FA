<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{% block title %}TOTP 管理器{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { primary: { DEFAULT: '#7C3AED' } } } } }
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>[x-cloak]{display:none!important}</style>
</head>
<body class="min-h-full bg-gray-50">
  <header class="sticky top-0 z-30 bg-white border-b border-gray-100 shadow-sm">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg sm:text-xl font-semibold text-black">Azure MFA 管理器</h1>

      {% set u = session.user if session.user else (user if user else None) %}
      {% if u %}
      <div class="flex items-center gap-2 sm:gap-3">
        <button type="button"
                onclick="window.dispatchEvent(new CustomEvent('open-add-modal'))"
                class="hidden sm:inline-flex items-center gap-2 px-3.5 py-2 rounded-lg border border-violet-600 text-violet-600 bg-transparent hover:bg-violet-600 hover:text-white transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
          添加密钥
        </button>

        <div x-data="{open:false}" class="relative">
          <button @click="open=!open" :aria-expanded="open" aria-haspopup="menu"
                  class="flex items-center gap-2 px-2.5 py-2 rounded-xl hover:bg-gray-100">
            {% if u.photo %}
              <img src="{{ u.photo }}" alt="用户头像" class="w-9 h-9 rounded-full object-cover ring-1 ring-white"/>
            {% else %}
              <div class="w-9 h-9 rounded-full bg-primary text-white flex items-center justify-center">
                <span class="text-sm font-bold">{{ (u.display_name or u.name or 'U')[:1] }}</span>
              </div>
            {% endif %}
            <span class="hidden sm:block text-sm font-medium text-gray-800 truncate max-w-[160px]">{{ u.display_name or u.name or '用户' }}</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
          </button>

          <div x-cloak x-show="open" @click.outside="open=false"
               x-transition.opacity x-transition.scale.origin.top.right
               class="absolute right-0 mt-2 w-72 bg-white rounded-2xl shadow ring-1 ring-gray-100 p-0 overflow-hidden">
            <div class="p-4 border-b border-gray-100 text-center">
              {% if u.photo %}
                <img src="{{ u.photo }}" alt="头像" class="w-14 h-14 rounded-full object-cover mx-auto"/>
              {% else %}
                <div class="w-14 h-14 rounded-full bg-primary text-white flex items-center justify-center mx-auto text-xl font-bold">{{ (u.display_name or u.name or 'U')[:1] }}</div>
              {% endif %}
            </div>
            <div class="p-4 space-y-3">
              <div><div class="text-xs text-gray-500">用户名</div><div class="text-sm text-gray-900 break-all">{{ u.display_name or u.name or '未知' }}</div></div>
              <div><div class="text-xs text-gray-500">电子邮件</div><div class="text-sm text-gray-900 break-all">{{ u.preferred_username or u.email or '未知' }}</div></div>
              {% if u.oid %}<div><div class="text-xs text-gray-500">用户 ID</div><div class="text-[12px] font-mono text-gray-800 break-all">{{ u.oid }}</div></div>{% endif %}
              {% if u.tid %}<div><div class="text-xs text-gray-500">租户 ID</div><div class="text-[12px] font-mono text-gray-800 break-all">{{ u.tid }}</div></div>{% endif %}
            </div>
            <div class="p-4 border-t border-gray-100">
              <a href="{{ url_for('auth.logout') }}"
                 class="w-full inline-flex items-center justify-center gap-2 px-3 py-2.5 rounded-lg
                        border border-red-500 text-red-600 bg-transparent
                        hover:bg-red-500 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 12H3m12 0l-4-4m4 4l-4 4"/></svg>
                退出登录
              </a>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </header>

  <main class="mx-auto max-w-6xl p-4">{% block content %}{% endblock %}</main>
  {% block scripts %}{% endblock %}
</body>
</html>